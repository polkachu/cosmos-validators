---
- name: setup public api/rpc/grpc endpoints
  become: true
  when: type != 'main'
  block:
    - name: set network endpoint prefix
      set_fact: 
        endpoint_prefix: '{{ "testnet-" if type == "testnet" else "" }}{{ custom_network | default(network) }}'

    - name: create caddyfile in /etc/Caddy/
      template:
        src: 'Caddyfile'
        dest: /etc/caddy/{{ network }}.caddy
        owner: 'root'
        group: 'root'
        mode: '0644'

    - name: open firewall
      import_tasks: set_firewall.yml

    - name: add endpoints to cloudflare
      import_tasks: set_cloudflare.yml

    - name: restart caddy service
      systemd:
        name: caddy
        state: restarted
        daemon_reload: yes
        enabled: yes
      changed_when: false
      run_once: true
